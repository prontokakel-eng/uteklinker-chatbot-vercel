âœ… Sanity-check plan infÃ¶r imorgon

Jag gÃ¥r igenom filerna vi jobbat med (baserat pÃ¥ dina senaste versioner):

gate.js

Importerar: normalizeMessage (utils-text.js), containsWhitelistWord, containsBlacklistWord, isGibberish (filters.js), checkRateLimit (rate-limiter.js).

Exporterar: runGate().
ğŸ‘‰ Ser konsistent ut, ingen dubbel logik.

filters.js

InnehÃ¥ller bara helpers (whitelist, blacklist, gibberish).
ğŸ‘‰ AnvÃ¤nds korrekt av gate.js.

rate-limiter.js

Exporterar checkRateLimit(ip) med bÃ¥de fast + slow limiter.
ğŸ‘‰ Integrerad i gate.js. Bra skydd mot bottar.

detect-lang-rules.js

Returnerar { lang, via } baserat pÃ¥ regex, anchors, heuristics, whitelist-boost.
ğŸ‘‰ Ingen filterlogik, precis som vi ville.

detect-lang-core.js

KÃ¶r rules â†’ fallback AI.

Returnerar sprÃ¥k, aldrig FILTER.
ğŸ‘‰ Tydligt ansvar, bra separation.

detect-lang.js

Tunn wrapper: detectLangSafe() â†’ detectLangCore().
ğŸ‘‰ Ingen krock.

chat.js

FlÃ¶de:

runGate()

detectLangSafe()

FAQ lookup (sheets.js)

AI fallback (med saveAiReply)
ğŸ‘‰ Nu skyddad mot req.headers-crash med ?..

sheets.js

HÃ¤mtar/sparar FAQ/AI via Google Sheets.
ğŸ‘‰ AnvÃ¤nds bara i chat.js. Ser bra ut.

tests/chatBot-torture-test-v3-NEW.mjs

Har headers: { "x-forwarded-for": "test-ip-${i}" } â†’ undviker rate-limit-block.

JÃ¤mfÃ¶r PreDetect vs ChatDetect.

Skriver till Sheets med layout.
ğŸ‘‰ Bra fÃ¶r felsÃ¶kning.

ğŸ” Slutsats

Allt ser konsistent och rent ut:

Gate = enda filter.

Detect-lang = bara sprÃ¥k.

Sheets = bara data.

Rate-limit = IP-skydd.

Test = robust export + mismatch-analys.

Imorgon kan vi fokusera helt pÃ¥ varfÃ¶r vissa SE/DA/DE-fall blir FILTER fast de borde passera.

ğŸ› ï¸ FelsÃ¶knings-checklista
1ï¸âƒ£ Grundtest â€“ PreDetect vs ChatDetect

KÃ¶r node tests/chatBot-torture-test-v3-NEW.mjs.

Filtrera i resultatet pÃ¥ alla rader dÃ¤r:

PreDetect â‰  ChatDetect

och ChatDetect = FILTER

Detta visar var sprÃ¥ket detekteras rÃ¤tt (PreDetect) men chatten Ã¤ndÃ¥ blockerar.

ğŸ‘‰ Om felet Ã¤r hÃ¤r â†’ det Ã¤r gate.js eller rate-limiter.js som stoppar i onÃ¶dan.

2ï¸âƒ£ Whitelist override check

FÃ¶r inputs med ord som finns i whitelist:

Ska ge via=whitelist i ChatDetect.

Om det Ã¤ndÃ¥ blir FILTER â†’ bug i containsWhitelistWord eller i gateâ€™s prioritering.

3ï¸âƒ£ Rate-limit falsklarm

Kolla loggar [RateLimiter].

Om samma test-ip blockeras fÃ¶r ofta â†’ Ã¶ka testfilens IP-spridning (redan patchat men dubbelkolla).

Om kunder riskerar blockas i prod:

Tunas via .env: RATE_LIMIT, RATE_LIMIT_WINDOW, RATE_LIMIT_FAST, RATE_LIMIT_FAST_WINDOW.

4ï¸âƒ£ Gibberish falsklarm

Om korta men giltiga inputs blockeras â†’ justera isGibberish() i filters.js.

T.ex. â€œCE?â€ ska inte flaggas som gibberish.

5ï¸âƒ£ Sheets fallback

Kolla saveAiReply fel (Unable to parse range: AI_SE!A:B).

Orsak: tabben AI_SE mÃ¥ste finnas i arket.

Skapa flikarna AI_SE, AI_DA, AI_DE, AI_EN i Google Sheet.

6ï¸âƒ£ Debug-loggar

Se till att gate.js returnerar via: "blacklist" | "whitelist" | "gibberish" | "rate-limit" | "pass".

LÃ¤gg till console.log i gate.js fÃ¶r alla brancher â†’ lÃ¤ttare se var det blockas.

âœ… Prioriterad ordning fÃ¶r imorgon

Kolla PreDetect vs ChatDetect mismatchar.

Whitelist override â€“ fungerar det alltid?

Rate-limit â€“ blockar den tester i onÃ¶dan?

Gibberish â€“ stÃ¤nger den ute korta frÃ¥gor felaktigt?

Sheets AI-flikar â€“ finns de i arket?

Vill du att jag redan nu gÃ¶r en patchad gate.js med extra console.log sÃ¥ vi ser exakt var blockeringen sker i steg 1?