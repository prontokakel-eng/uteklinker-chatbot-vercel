# Master — Systemöversikt (Codex)

**Senast uppdaterad:** 2025-10-09 11:10 UTC  
**Stack:** Node 20.19.5, Vercel (dev/prod), Vanilla JS + HTML/CSS  
**Kärnprinciper:** FAQ-first, AI-fallback, Gate & Filters före allt, språk SE/EN/DA/DE, top-N FAQ som AI‑kontekst.

---

## Vad som uppdaterades idag (WL/BL, normalisering, gate, smoke‑tester)

### 1) Filter‑konfiguration (`/lib/filters-config.js`)
- Robust JSON‑inläsning + toleranta format:
  - Läser `config/BL-WL-words-list.json` → bygger `allowlists` och `blocklists` per språk.
  - Mergar **`sizes.json`** (kan vara array *eller* `{ sizes: [...] }`) in i **WL.ALL**.
  - Läser **`neutral-words.json`** i tre möjliga former: array (ALL), `{ NEUTRAL: {…} }` eller `{ SE/EN/DA/DE/ALL }`.
- Ny helpers:
  - `normArr` som kan flatten/extrahera strängar även från objektvärden.
  - `mergeAllFirst(listByLang, lang)` för säkra per‑språklistor (ALL först, sedan språk).
- Publika getters:
  - `getWhitelistForLang(lang)` • `getBlacklistForLang(lang)` • `getNeutralForLang(lang)`
  - `reloadFiltersConfig()` för re‑laddning vid test.
- Loggar lastade antal: `WL loaded: X | BL loaded: Y | NEU loaded: Z`

### 2) Whitelist/Blacklist‑motor (`/lib/wl-bl-filters.js`)
- Centraliserad normalisering:
  - Gemener, `×/✕ → x`, trim, hoptryckta mellanslag, **`" cm" → "cm"`**.
- **Smart matchning (`includesSmart`)**:
  - **Alfabetiska tokens** måste träffa **ordgräns** (`\b...\b`) för att undvika falska positiver.
  - **Siffror/format** (t.ex. `60x60cm`, `600x600mm`) matchas tolerant (även “no‑space”-variant).
- **Säker ALL‑hantering**:
  - När `lang="ALL"` tillåts **endast numeriska/format‑termer** från ALL‑listan.
  - När `lang` är konkret (SE/EN/DA/DE) gäller: **alfabetiska ALL‑termer måste också finnas i språkets WL**.
- Offentlig API oförändrad: `applyWhitelist(text, {lang})` och `applyBlacklist(text, {lang})`.

### 3) Format & storlekar
- **`config/sizes.json`**: normaliseringskarta mellan kundens inmatning och kanoniskt format (ex. *“60 x 60”, “60x60 cm”* → **`60x60cm`**).
- **`config/formats.json`**: lista över alla kanoniska format (ex. `60x60cm`, `100x100cm`, `120x120cm`, …).  
  Dessa mergas in i **WL.ALL** → WL träffar även fraser som innehåller avstånd/mellanslag/“mm”.

### 4) Gate‑ordning (`/lib/gate.js`)
1. **Kandidat‑språk** beräknas tidigt: `detectShortLangWord` → `getIpLang(ip)` → fallback `ALL`.
2. **Whitelist** (med kandidat‑språk) → släpper igenom säkra domänord direkt.
3. **Blacklist** → blockerar hårt.
4. **Gibberish** → stoppar meningslöst.
5. **Kortord (short‑word)** → kan returnera direkt med hög confidence.
6. **Hälsning** (SE default) → tillåts passera.
7. **Språkdetektor (`detectLangCore`)** med **IP‑hint** (icke‑blockerande).
8. **Rate‑limit**.
- Returnerar `{ filtered, reason, via, lang }` och loggar `gate.log` händelser.

### 5) Smoke‑tester (PowerShell)
Scripts (i `package.json`):  
- `test:smoke:wlbl` — snabba WL/BL‑träffar: `60 x 60 cm`, `100x100 cm`, neutralord och `viagra`.
- `test:smoke:formats` — kontrollerar att normaliseringskoden laddar och körs.
- `test:smoke:gate` — kör `gateMessage(...)` med typiska inputs (WL/BL/greeting/format).
- Aggregat: `test:smoke` kör alla tre.

**Exempel på grön körning:**
```
[OK] WL should match 60 x 60 cm
[OK] WL should match 100x100 cm
[OK] BL should block 'viagra'
[OK] WL should not trigger on neutral word
[OK] formats normalization ran
```

### 6) Resultat/telemetri vi sett under dagen
- Typiska lastloggar: `WL loaded: 1160–1175 | BL loaded: 181 | NEU loaded: 447`.
- Exempelträffar: 
  - WL: `60x60cm`, `100x100cm`, materialord (ex. *granit*), säkra funktion‑ord när **per‑språk**.
  - BL: `viagra` m.fl. typiska spamord.
- Gate visar `IP hint: <ip> -> <country>` samt snabbpass när kortord/greeting matchar.

### 7) Rekommenderad ordning i pipeline (sammanfattning)
`WL → BL → Gibberish → ShortWord → Greeting → DetectLangCore(+IP) → RateLimit`

---

## Övrigt oförändrat innehåll
Se tidigare version av **master‑dokumentet** för djupare detaljer om FAQ/Sheets/AI/tortyrsvit.
