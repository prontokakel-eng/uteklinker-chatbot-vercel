# Master ‚Äî System√∂versikt (Codex)

> **Senast uppdaterad:** 2025-10-09  
> **Stack:** Node 20.19.5, Vercel (dev/prod), Vanilla JS + HTML/CSS  
> **K√§rnprinciper:** FAQ-first, AI-fallback, Gate & Filters f√∂re allt, spr√•k SE/EN/DA/DE, top-N FAQ som AI-kontekst.

_Nedan f√∂ljer tidigare ‚Äúmaster-2025-10-09.md‚Äù-inneh√•ll of√∂r√§ndrat._


Detta dokument sammanfattar **dagens uppdateringar** och beslut f√∂r FAQ‚Äëf√∂rst chatbot-projektet, inklusive
lexikon‚Äëdriven spr√•kdetektion (v6.3), milj√∂/Sheets‚Äëhantering, samt tortyrsviten.

---

## 1) Arkitektur (aktuell)
```
/lib
  gate.js
  filters.js
  block-long.js
  detect-lang-core.js          # v6.3: regex ‚Üí heuristik ‚Üí SE-fallback ‚Üí grupp ‚Üí IP ‚Üí AI (lexikonstyrt)
  detect-lang-rules.js         # v6.3: regler/ankare via lexikon (inga h√•rdkodade listor)
  detect-lang-heuristics.js    # v6.3: token/diakrit-heuristik via lexikon (cache)
  text-normalize.js            # central normalisering
  faq-fuzzy-detect.js
  faq-data.js
  faq-cache.js
  faq-sheets.js                # Google Sheets I/O + batch-k√∂ + flush
  openai-client.js             # laddar .env.local / tests/.env
  load-env.js / env-check.js   # robust env-laddning + konfliktcheck
  logger.js
/tests
  Super-torture-suite.repo.mjs # tortyrsvit (CLI, rapport, JUnit)
  utils/adapters.mjs           # tunn adapter (gates/lang/faq/ask/log) f√∂r sviten
  fixtures/                    # testdata (near/local/long/negatives ‚Ä¶)
  logs/
/config
  gates.json / keywords.json / allowlists.json / blocklists.json
  lexicon/
    SE_FULL_LOOKUP.json EN_FULL_LOOKUP.json DA_FULL_LOOKUP.json DE_FULL_LOOKUP.json  # ord, negationer, regex, normalize, geoMapping, weights
```
---

## 2) Spr√•kdetektion v6.3 ‚Äî Lexikon‚Äëdriven

**Pipeline i `detect-lang-core.js`:**
1. **Regex (rulesOnly)** ‚Üí `via="regex-exclusive"` n√§r ett spr√•k har unika ankare (t.ex. `√•/√§/√∂`, `√¶/√∏/√•`, `√ü/√§/√∂/√º`).
2. **Heuristik (group)** ‚Üí direktretur vid `confidence ‚â• 0.8`.
3. **SE‚Äëfallback (lexikon)** ‚Üí `fallbackTriggers` / `fallbackExcludes` per spr√•k.
4. **Gruppanalys** (ytterligare heuristikomg√•ng).
5. **IP‚Äëtiebreak** ‚Üí `geoMapping` i lexikon.
6. **AI fallback** (om till√•ten) ‚Üí strikt etikett (SE/DA/DE/EN), `temperature: 0`.

**Normalisering** styrs av lexikon: `normalize.methods` (t.ex. `["NFD","NFC"]`), `normalize.remove` (kombinerande mark√∂rer),
och `accentMap` (t.ex. `"√ü":"ss"`). Ingen h√•rdkodad diakrit‚Äëreplace i core/rules/heuristics.

**`detect-lang-rules.js` (patchad)** anv√§nder nu:
- `regexAnchors.exclusive` + `regexAnchors.soft`
- `articles`, `negations`, `common`, `regex.prefix/suffix`
- `weights` (artiklar/negationer/common/regex/anchors/anchorsSoft)

---

## 3) Lexikon ‚Äî schema & README

Se README: [lexicon-README.md](sandbox:/mnt/data/lexicon-README.md)

**Kort schema per spr√•k:**
```jsonc
{
  "lang": "SE",
  "articles": [], "negations": [], "common": [],
  "regex": { "prefix": [], "suffix": [] },
  "regexAnchors": { "exclusive": [], "soft": [] },
  "boosters": [],
  "fallbackTriggers": [], "fallbackExcludes": [],
  "normalize": { "methods": ["NFD","NFC"], "remove": ["[\\u0300-\\u036f]"] },
  "accentMap": {},
  "geoMapping": {"SE":"SE","GB":"EN"},
  "weights": {"articles":0.6,"negations":0.4,"common":0.3,"regex":0.5,"anchors":0.6,"anchorsSoft":0.25}
}
```
**Placering:** `/config/lexicon/SE.json` m.fl.

---

## 4) Milj√∂ & laddning

- **Test:** `tests/.env` prioriteras (loggas: `[load-env] üß™ Test environment loaded: ...`)  
- **Lokal/dev:** `.env.local` i projektroten (och i `/lib/openai-client.js` laddas den via absolut path).  
- **Prod (Vercel):** `.env.vercel`

`load-env.js` sanerar bl.a. `GCP_PRIVATE_KEY` (radbrytningar) och loggar prefix/suffix f√∂r kritiska variabler.

---

## 5) Google Sheets ‚Äî batchning

- `queueBenchmarkResult(entry)` ‚Üí l√§gger i k√∂
- `flushPendingWrites(sheetId)` ‚Üí appendar per tab i slutet (RPM‚Äëv√§nligt)
- `clearSheet(sheetId, tab)` ‚Üí blockerad i prod; kr√§ver `CLEAR_GOOGLE_TAB_BEFORE_RUN=true` i dev/test

**Rekommenderade env vid test:**
```
FAQ_SHEETS_OFFLINE_CACHE=./tests/fixtures/faq-cache
FAQ_SHEETS_READ_MAX_RPM=20
FAQ_SHEETS_READ_RETRIES=3
FAQ_SHEETS_READ_BACKOFF_MS=15000
```

---

## 6) Tortyrsvit ‚Äî k√∂rning & flaggor

**Exempel (snabb):**
```powershell
node .\tests\Super-torture-suite.repo.mjs --input .\tests\fixtures --limit=20 --parallel=12 --ai-fallback=off --dedup-threshold=0.10
```

**Flaggor:**
- `--input`, `--langs`, `--report`, `--parallel`, `--seed`
- `--ai-fallback=auto|on|off` (respekterar `.env.local`/`tests/.env`)
- `--dedup-threshold=0.10` (Levenshtein/L)
- `--assert-lang=true|false`
- `--ignore-case-lang=true|false`
- `--limit=<n>`
- `--truncate=<len>` (snabbt l√§ge genom att kapa input)

**Rapporter:**
- JSON: `./reports/torture-report.json`
- JUnit: `./reports/junit.xml`
- KPI: counts, per‚Äëlang, P95 (gates/detect/lookup/ai/total), samt flagg‚Äëprovenans

**Nyliga autotune‚Äëfynd (limit=40):**
- Sweet spot kring `--parallel=12` (‚âà 240 s p√• din maskin, CPU < 30%)
- H√∂gre `parallel` gav begr√§nsad vinst pga I/O/kvoter.

---

## 7) Adapters (f√∂r sviten)

`/tests/utils/adapters.mjs` exponerar:
- `runGates` (l√§ser `/config`), `detectLang` (via lib), `faqLookup` (via Fuse‚Äëindex), `ask` (OpenAI klient), `logger` (via `/lib/logger.js`).
- **Inga dom√§nlogik√§ndringar** ‚Äî endast tunn brygga.

---

## 8) Roadmap (n√§sta steg)

1. **Lexikal tiebreaker** f√∂re IP/AI: anv√§nd `*_FULL_LOOKUP` i cache f√∂r snabb, icke‚ÄëAI bias.
2. **Ordering-bias test** i sviten: samma fr√•ga ‚Üí samma svar oavsett kandidatordning.
3. **Context-bleed test**: AI-svar ska inte l√§cka till n√§sta case.
4. **Rate-limit/backoff simulering** (429/5xx) + circuit breaker.
5. **Tokenizer-stress** & **too-long** fall (kontrollerad truncation).
6. **Locale-format** verifiering (datum/tal/valuta per spr√•k).
7. **Ambiguous queries** ‚Üí f√∂rslag/klarg√∂randen, inte random FAQ-svar.

---

## 9) QA-checklista

- [ ] Imports/exports of√∂r√§ndrade; patchar endast med `// CHANGE:`‚Äëkommentarer.
- [ ] `detect-lang-lexicon.test.mjs` passerar.
- [ ] Tortyrsvit k√∂rd med liten `--limit` f√∂ljt av full k√∂rning.
- [ ] `ai-fallback=off` ger noll AI‚Äëanrop.
- [ ] Sheets‚Äëbatch flushar endast i slutet (RPM h√•lls l√•g).
- [ ] Per‚Äëspr√•k precision acceptabel (SE ‚âà 98%, EN ‚âà 96%, DA ‚âà 88%, DE ‚âà 81% i senaste run).

---

## 10) Relaterade artefakter (nedladdning)
- Lexikon README: [lexicon-README.md](sandbox:/mnt/data/lexicon-README.md)
- Patch: `detect-lang-rules.js` (lexikon‚Äëdriven): [download](sandbox:/mnt/data/detect-lang-rules.lexicon-patch.js)

---

## 11) Snabb runbook

**Sanity (lexikon):**
```bash
NODE_ENV=test node tests/detect-lang-lexicon.test.mjs
```

**Snabb tortyr:**
```powershell
node .\tests\Super-torture-suite.repo.mjs --input .\tests\fixtures --limit=20 --parallel=12 --ai-fallback=off
```

**Full tortyr (utan AI):**
```powershell
node .\tests\Super-torture-suite.repo.mjs --parallel=12 --ai-fallback=off
```

**Full tortyr (med AI, kontrollerad):**
```powershell
node .\tests\Super-torture-suite.repo.mjs --parallel=6 --ai-fallback=on
```
