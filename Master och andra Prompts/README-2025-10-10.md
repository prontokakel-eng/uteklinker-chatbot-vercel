# README — Dagens arbete (2025-10-09 11:10 UTC)

Den här README'n sammanfattar exakt vad som patchades och hur du verifierar det lokalt.

## Ändrade/nya filer
- **/lib/filters-config.js**
  - Ny robust `normArr`, stöd för `sizes.json`, `neutral-words.json`.
  - Offentliga getters: `getWhitelistForLang`, `getBlacklistForLang`, `getNeutralForLang`, `reloadFiltersConfig`.
  - Loggar antal WL/BL/NEU.
- **/lib/wl-bl-filters.js**
  - Normalisering (gemener, `×/✕→x`, hopträngda mellanslag, `" cm"→"cm"`).
  - `includesSmart`: ordgräns på alfabetiska tokens, tolerant substring för siffror/format.
  - Säker ALL‑hantering (alfabetiska ALL‑termer kräver lokalt språk‑stöd; numeriska ALL alltid ok).
- **/lib/gate.js**
  - Kandidat‑språk tidigt (ShortWord→IP→ALL).
  - WL/BL med kandidat‑språk, därefter gibberish, shortword, greeting, detectLangCore(+IP), rate‑limit.
- **/config/sizes.json**
  - Normaliseringskarta (varianter → kanoniskt). Används indirekt via filters‑konfig.
- **/config/formats.json**
  - Lista av kanoniska format; mergas in i WL.ALL.
- **/config/neutral-words.json**
  - Neutralord som aldrig ska trigga WL. Läser flera JSON‑format.

## Snabb verifikation
```powershell
npm run test:smoke
```
Förväntat (grönt):
```
[OK] WL should match 60 x 60 cm
[OK] WL should match 100x100 cm
[OK] BL should block 'viagra'
[OK] WL should not trigger on neutral word
[OK] formats normalization ran
```

## Vanliga fällor & fix
- **Ogiltig `package.json`**: se till att JSON är giltigt (inga duplicerade toppnivå‑objekt).
- **Miljövariabler i test**: `tests/.env` prioriteras. `GCP_PRIVATE_KEY` saneras automatiskt (radbrytningar).
- **Cache**: anropa `reloadFiltersConfig()` när du ändrar filer i `/config` under test.

## Nästa steg (rekommenderat)
1. Utöka **formats.json** med fler kanoniska mått (inkl. mm→cm logik ifylld i WL/normalisering).
2. Lägg till fler BL‑termer för spam/fraud (svag linting på plural/singular).
3. Kör tortyrsviten med `--limit=200`, `ai-fallback=off` för ren lexikal stabilitet, sedan `on`.
4. Sätt upp CI‑jobb som kör smoke + subset av tortyrsviten på PR.
